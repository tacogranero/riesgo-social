<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Índice de Riesgo Social</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #e0eafc, #cfdef3);
            padding: 40px 20px;
            color: #333;
        }

        .container {
            max-width: 960px;
            margin: 40px auto;
            background: #ffffffdd;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 500;
            color: #34495e;
        }

        input[type="number"],
        select {
            width: calc(100% - 22px);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-top: 8px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            flex-grow: 1;
            max-width: 250px;
        }

        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        canvas {
            margin-top: 40px;
            max-height: 400px;
            display: block;
        }

        #recomendacion {
            margin-top: 30px;
            padding: 20px;
            border-left: 6px solid; /* El color se define por JS */
            border-radius: 10px;
            line-height: 1.6;
            font-size: 1.1em;
            display: none; /* Oculto por defecto */
        }

        #recomendacion.low {
            background: #ecf9ec;
            border-color: #2e7d32;
            color: #2e7d32;
        }

        #recomendacion.medium {
            background: #fffbe6;
            border-color: #fdd835;
            color: #fbc02d;
        }

        #recomendacion.high {
            background: #ffebe6;
            border-color: #e74c3c;
            color: #e74c3c;
        }

        #alertaRoja {
            margin-top: 25px;
            font-weight: bold;
            color: #c0392b;
            font-size: 1.4em;
            display: none;
            text-align: center;
            padding: 15px;
            background-color: #fdeded;
            border-radius: 10px;
            border: 2px solid #e74c3c;
        }

        table {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: none; /* Oculto por defecto */
        }

        th,
        td {
            border: 1px solid #eee;
            padding: 15px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        tr:nth-child(even) {
            background-color: #f8f8f8;
        }

        .hidden {
            display: none !important;
        }
        
        /* Contenedor para gráfico */
        #irsChartContainer {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Calculadora de Índice de Riesgo Social (IRS)</h2>

        <form id="irsForm">
            <label for="ingresos">Ingresos Mensuales Netos ($):</label>
            <input type="number" id="ingresos" step="0.01" min="0" required placeholder="Ej: 1500.00">

            <label for="gastos">Gastos Mensuales Totales ($):</label>
            <input type="number" id="gastos" step="0.01" min="0" required placeholder="Ej: 1200.00">

            <label for="dependientes">Número de Dependientes (ej. hijos, adultos mayores):</label>
            <input type="number" id="dependientes" min="0" required value="0">

            <label for="tipoVivienda">Tipo de Vivienda:</label>
            <select id="tipoVivienda" required>
                <option value="propia">Propia (Pagada)</option>
                <option value="hipoteca">Propia (Con Hipoteca)</option>
                <option value="alquilada">Alquilada</option>
                <option value="prestada">Prestada / Familiar</option>
            </select>

            <div class="button-group">
                <button type="submit">Calcular IRS</button>
                <button type="button" id="cargarExcelBtn">Cargar Datos desde Excel</button>
                <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden">
            </div>
        </form>

        <div id="irsChartContainer">
            <canvas id="irsChart"></canvas>
        </div>

        <div id="recomendacion">
            <strong>Recomendación:</strong> <span id="recomendacionTexto"></span>
        </div>

        <div id="alertaRoja">
            ¡ATENCIÓN! Tu Índice de Riesgo Social es ALTO. Se recomienda buscar asesoría financiera urgente.
        </div>

        <div id="detalleGastos" class="hidden">
            <h3>Detalle de Gastos</h3>
            <p>Aquí podrías ver un desglose más detallado de tus gastos si se proporcionaran más categorías en el formulario o el archivo Excel.</p>
        </div>

        <table id="gastosTabla" class="hidden">
            <thead>
                <tr>
                    <th>Concepto</th>
                    <th>Monto</th>
                </tr>
            </thead>
            <tbody id="gastosTableBody">
                </tbody>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elementos del DOM ---
            const irsForm = document.getElementById('irsForm');
            const ingresosInput = document.getElementById('ingresos');
            const gastosInput = document.getElementById('gastos');
            const dependientesInput = document.getElementById('dependientes');
            const tipoViviendaSelect = document.getElementById('tipoVivienda');

            // Elementos de resultado
            const recomendacionDiv = document.getElementById('recomendacion');
            const recomendacionTexto = document.getElementById('recomendacionTexto');
            const alertaRojaDiv = document.getElementById('alertaRoja');
            const detalleGastosDiv = document.getElementById('detalleGastos');
            const gastosTabla = document.getElementById('gastosTabla');
            const gastosTableBody = document.getElementById('gastosTableBody');

            // Botones y manejo de archivos
            const cargarExcelBtn = document.getElementById('cargarExcelBtn');
            const excelFileInput = document.getElementById('excelFileInput');

            let myChart; // Variable para la instancia del gráfico

            // --- Función para Inicializar o Actualizar el Gráfico ---
            function updateChart(irsScore) {
                const irsChartCanvas = document.getElementById('irsChart');
                const irsChartContainer = document.getElementById('irsChartContainer');
                
                // Mostrar contenedor del gráfico
                irsChartContainer.style.display = 'block';

                if (!irsChartCanvas) {
                    console.error("Error: El elemento canvas con ID 'irsChart' no se encontró.");
                    return;
                }

                const ctx = irsChartCanvas.getContext('2d');

                if (myChart) {
                    // Actualizar un gráfico existente
                    myChart.data.datasets[0].data[0] = irsScore;
                    // Cambiar color según el riesgo
                    let color;
                    if (irsScore < 20) {
                        color = 'rgba(46, 178, 107, 0.7)'; // Verde para riesgo bajo
                    } else if (irsScore < 50) {
                        color = 'rgba(255, 193, 7, 0.7)'; // Amarillo para riesgo medio
                    } else {
                        color = 'rgba(231, 76, 60, 0.7)'; // Rojo para riesgo alto
                    }
                    myChart.data.datasets[0].backgroundColor[0] = color;
                    myChart.update();
                } else {
                    // Inicializar un nuevo gráfico si no existe
                    myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Índice de Riesgo Social'],
                            datasets: [{
                                label: 'IRS',
                                data: [irsScore], // Usar el IRS calculado inicialmente
                                backgroundColor: ['rgba(54, 162, 235, 0.6)'], // Color por defecto
                                borderColor: ['rgba(54, 162, 235, 1)'],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100 // Escala máxima para el IRS
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'Valor del Índice de Riesgo Social (IRS)'
                                }
                            }
                        }
                    });
                }
            }

            // --- Función Principal de Cálculo del IRS ---
            function calcularIRS(event) {
                event.preventDefault(); // Evita que el formulario se envíe y recargue la página

                // Validación mejorada: campos vacíos
                if (!ingresosInput.value || !gastosInput.value) {
                    alert('Por favor, completa todos los campos obligatorios.');
                    return;
                }

                const ingresos = parseFloat(ingresosInput.value);
                const gastos = parseFloat(gastosInput.value);
                const dependientes = parseInt(dependientesInput.value);
                const tipoVivienda = tipoViviendaSelect.value;

                // Validaciones básicas
                if (isNaN(ingresos) || isNaN(gastos) || isNaN(dependientes) || ingresos < 0 || gastos < 0 || dependientes < 0) {
                    alert('Por favor, ingresa valores numéricos válidos y no negativos para todos los campos.');
                    return;
                }

                let irs = 0; // Inicializar el Índice de Riesgo Social

                // 1. Componente de Ingresos vs. Gastos
                if (ingresos === 0) {
                    irs += 50; // Riesgo muy alto si no hay ingresos
                } else if (gastos > ingresos) {
                    irs += 40; // Gastos superan ingresos
                } else {
                    const ratioGastoIngreso = gastos / ingresos;
                    if (ratioGastoIngreso >= 0.8) {
                        irs += 25; // Más del 80% de ingresos se va en gastos
                    } else if (ratioGastoIngreso >= 0.6) {
                        irs += 10; // Entre 60% y 80%
                    }
                }

                // 2. Componente de Dependientes
                irs += dependientes * 5; // Cada dependiente añade 5 puntos de riesgo

                // 3. Componente de Tipo de Vivienda
                switch (tipoVivienda) {
                    case 'alquilada':
                        irs += 15;
                        break;
                    case 'hipoteca':
                        irs += 10;
                        break;
                    case 'prestada':
                        irs += 5;
                        break;
                    case 'propia':
                    default:
                        // No añade riesgo significativo por sí misma
                        break;
                }

                // Limitar el IRS a un máximo de 100 para que el gráfico no se desborde
                irs = Math.min(irs, 100);

                // --- Mostrar Resultados ---
                updateChart(irs); // Llama a la función que inicializa o actualiza el gráfico
                mostrarRecomendaciones(irs);
            }

            // --- Función para Mostrar Recomendaciones ---
            function mostrarRecomendaciones(irs) {
                recomendacionDiv.style.display = 'block';
                alertaRojaDiv.style.display = 'none';
                recomendacionDiv.className = ''; // Limpiar clases anteriores
                recomendacionDiv.classList.add('recomendacion'); // Asegurar clase base

                let textoRecomendacion = '';
                if (irs < 20) {
                    textoRecomendacion = 'Tu índice de riesgo social es **Bajo**. ¡Felicidades! Mantén una buena gestión de tus finanzas y considera ahorrar e invertir para el futuro.';
                    recomendacionDiv.classList.add('low');
                } else if (irs < 50) {
                    textoRecomendacion = 'Tu índice de riesgo social es **Medio**. Es aconsejable revisar tus gastos y posiblemente buscar formas de aumentar tus ingresos o reducir dependencias para mejorar tu estabilidad.';
                    recomendacionDiv.classList.add('medium');
                } else {
                    textoRecomendacion = 'Tu índice de riesgo social es **Alto**. Es urgente que revises tu situación financiera. Busca asesoría profesional, evalúa tus gastos, y considera opciones para generar más ingresos o acceder a apoyos sociales.';
                    alertaRojaDiv.style.display = 'block';
                    recomendacionDiv.classList.add('high');
                }
                recomendacionTexto.innerHTML = textoRecomendacion;
                recomendacionDiv.classList.remove('hidden'); // Asegurar que sea visible
            }

            // --- Funcionalidad de Carga de Excel ---
            cargarExcelBtn.addEventListener('click', () => {
                excelFileInput.click(); // Simular clic en el input de tipo file
            });

            excelFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {
                            type: 'array'
                        });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const json = XLSX.utils.sheet_to_json(worksheet);

                        if (json.length > 0) {
                            const row = json[0]; // Usar la primera fila de datos

                            // Intentar poblar el formulario
                            if (row.Ingresos !== undefined) ingresosInput.value = row.Ingresos;
                            if (row.Gastos !== undefined) gastosInput.value = row.Gastos;
                            if (row.Dependientes !== undefined) dependientesInput.value = row.Dependientes;
                            if (row.Tipo_Vivienda !== undefined) {
                                const viviendaValue = String(row.Tipo_Vivienda).toLowerCase();
                                // Asegurarse de que el valor del Excel coincida con una opción del select
                                if (['propia', 'hipoteca', 'alquilada', 'prestada'].includes(viviendaValue)) {
                                    tipoViviendaSelect.value = viviendaValue;
                                }
                            }

                            // Opcional: Mostrar gastos detallados si el Excel tiene más columnas
                            gastosTableBody.innerHTML = ''; // Limpiar tabla
                            let hasDetailedExpenses = false;
                            for (const key in row) {
                                // Evitar los campos ya mapeados y otros campos que no son gastos específicos
                                if (!['Ingresos', 'Gastos', 'Dependientes', 'Tipo_Vivienda'].includes(key) && row[key] !== null && row[key] !== '') {
                                    const tr = document.createElement('tr');
                                    tr.innerHTML = `<td>${key}</td><td>$${parseFloat(row[key]).toFixed(2)}</td>`;
                                    gastosTableBody.appendChild(tr);
                                    hasDetailedExpenses = true;
                                }
                            }

                            if (hasDetailedExpenses) {
                                gastosTabla.classList.remove('hidden');
                                detalleGastosDiv.classList.remove('hidden');
                            } else {
                                gastosTabla.classList.add('hidden');
                                detalleGastosDiv.classList.add('hidden');
                            }

                            alert('Datos cargados correctamente desde Excel. Haz clic en "Calcular IRS" para ver resultados.');
                        } else {
                            alert('El archivo Excel está vacío o no contiene datos válidos. Verifica el formato.');
                        }
                    };
                    reader.onerror = (error) => {
                        console.error('Error al leer el archivo:', error);
                        alert('Hubo un error al leer el archivo Excel.');
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            // --- Event Listeners ---
            irsForm.addEventListener('submit', calcularIRS);
        });
    </script>
</body>
</html>
